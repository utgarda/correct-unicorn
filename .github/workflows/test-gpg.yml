name: Test GPG Signing

on:
  workflow_dispatch:

jobs:
  test-gpg:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Import GPG key manually
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          echo "$GPG_PRIVATE_KEY" | gpg --import --batch --yes

      - name: Configure GPG for CI
        run: |
          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg
          echo "allow-loopback-pinentry" > ~/.gnupg/gpg-agent.conf
          echo "pinentry-mode loopback" > ~/.gnupg/gpg.conf
          echo "use-agent" >> ~/.gnupg/gpg.conf
          chmod 600 ~/.gnupg/gpg-agent.conf ~/.gnupg/gpg.conf
          gpg-connect-agent reloadagent /bye

      - name: List GPG keys
        run: |
          gpg --list-secret-keys --keyid-format LONG

      - name: Create test file
        run: |
          echo "test signing" > test.txt

      - name: Sign test file
        run: |
          export GPG_TTY=$(tty)
          gpg --batch --yes --pinentry-mode loopback --armor --detach-sign test.txt
          ls -la test.txt*

      - name: Verify signature
        run: |
          gpg --verify test.txt.asc test.txt
